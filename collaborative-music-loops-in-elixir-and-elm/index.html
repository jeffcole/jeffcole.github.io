<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='width=device-width, initial-scale=1' name='viewport'>
<meta content='I write about building things.' name='description'>
<meta content='jeff cole' name='keywords'>
<meta content='Jeff Cole - Collaborative Music Loops in Elixir and Elm' property='og:title'>
<meta content='article' property='og:type'>
<meta content='http://gravatar.com/avatar/b510f21d7375664c0425d07417016afd.jpg' property='og:image'>
<meta content='https://jeffcole.github.io/collaborative-music-loops-in-elixir-and-elm/' property='og:url'>
<title>Jeff Cole - Collaborative Music Loops in Elixir and Elm</title>
<link href='https://jeffcole.github.io/collaborative-music-loops-in-elixir-and-elm/' rel='canonical'>
<link href='//fonts.googleapis.com/css?family=Lusitana:400,700' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Merriweather+Sans:400,300,300italic,400italic,700italic,700,800,800italic' rel='stylesheet' type='text/css'>
<link href="../assets/stylesheets/application.css" rel="stylesheet" />
</head>
<body class='collaborative-music-loops-in-elixir-and-elm collaborative-music-loops-in-elixir-and-elm_index type-system-serif'>
<header>
<h1>
Jeff Cole
<a href='/' title='Home'>
<i class='fa fa-fw fa-home'></i>
</a>
</h1>
</header>
<main>
<section class='intro'>
<h3 class='tagline'>
<span>I build things with computers,</span>
<span>for people.</span>
</h3>
<p class='contact'>
<a href="https://github.com/jeffcole"><i class='fa fa-fw fa-2x fa-github' title='GitHub'></i>
</a><a href="https://www.linkedin.com/in/jeffreydcole"><i class='fa fa-fw fa-2x fa-linkedin' title='LinkedIn'></i>
</a><a href="mailto:jeffreydonaldcole@gmail.com"><i class='fa fa-fw fa-2x fa-envelope' title='Email'></i>
</a></p>

</section>
<article>
<h1>Collaborative Music Loops in Elixir and Elm</h1>
<p class='date'>
October  5, 2016
</p>

<p>When I started learning <a href="http://elixir-lang.org/">Elixir</a> and checking out <a href="http://www.phoenixframework.org/">Phoenix</a>, one of the things that struck me was the platform's first-class support for the real-time web. Once you get a handle on Elixir and become accustomed to programming in a functional style, it's a joy to work with the abstractions that the Phoenix team has set up around sockets and channels.</p>

<p>I came up with an idea for a project to test drive these features. And if I was going to be using functional programming, I figured I might as well do it all the way up the stack. The <a href="http://elm-lang.org/">Elm</a> language stands to transform how we write client-side applications, along with how well we enjoy the experience.</p>

<p>In this series, I want to highlight the interesting abstractions provided by Elixir, Phoenix, and Elm that make building these types of applications much more pleasant than in the past.</p>

<p>The first few posts in the series will explore how Elixir and Phoenix gave me the right tools to write the back end for <a href="http://loops-with-friends.herokuapp.com/">Loops With Friends</a>, a collaborative music-making web app. The app supports up to seven users in a given "jam," in which each user gets their own music loop. Each user can start and stop their loop to make music in real time with the other users in the jam. The app automatically creates and balances additional jams as necessary as users join and leave.</p>

<p>As we go, I'll highlight the bits of code that are relevant to understanding how everything is wired together, incrementally adding lines to existing functions. Be sure to check out the full code via the links if you'd like to see the final source and tests. We won't spend much time on the details of data transformation, so if you're new to Elixir, a great place to start is the <a href="http://elixir-lang.org/getting-started/introduction.html">Elixir Guides</a>.</p>

<h2 id="joining-a-jam">Joining a Jam</h2>

<p>When a player visits the app, the server sends down the client-side code, along with a jam identifier. The client-side code then immediately requests a WebSocket connection to a Phoenix channel for that identifier. The server application's <code>Endpoint</code> module [<a href="https://github.com/jeffcole/loops_with_friends/blob/back-end-blog-posts/lib/loops_with_friends/endpoint.ex">source</a>] binds the <code>/socket</code> path to the <code>UserSocket</code> module.</p>

<pre class="highlight elixir"><code><span class="c1"># lib/loops_with_friends/endpoint.ex</span>&#x000A;<span class="k">defmodule</span> <span class="no">LoopsWithFriends</span><span class="o">.</span><span class="no">Endpoint</span> <span class="k">do</span>&#x000A;  <span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">Endpoint</span><span class="p">,</span> <span class="ss">otp_app:</span> <span class="ss">:loops_with_friends</span>&#x000A;&#x000A;  <span class="n">socket</span> <span class="sd">"</span><span class="s2">/socket"</span><span class="p">,</span> <span class="no">LoopsWithFriends</span><span class="o">.</span><span class="no">UserSocket</span>&#x000A;&#x000A;  <span class="c1"># ...</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre>
<p>The <code>UserSocket</code> module [<a href="https://github.com/jeffcole/loops_with_friends/blob/back-end-blog-posts/web/channels/user_socket.ex">source</a> | <a href="https://github.com/jeffcole/loops_with_friends/blob/back-end-blog-posts/test/channels/user_socket_test.exs">test</a>] declares the channels that are supported over the socket. The pattern <code>"jams:*"</code> specifies what topics requested by the client the channel will match on. Meanwhile, the <code>connect</code> function assigns a user ID to the socket so that we can know which user we are communicating with at all points after the initial connection.</p>

<pre class="highlight elixir"><code><span class="c1"># web/channels/user_socket.ex</span>&#x000A;<span class="k">defmodule</span> <span class="no">LoopsWithFriends</span><span class="o">.</span><span class="no">UserSocket</span> <span class="k">do</span>&#x000A;  <span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">Socket</span>&#x000A;&#x000A;  <span class="n">channel</span> <span class="sd">"</span><span class="s2">jams:*"</span><span class="p">,</span> <span class="no">LoopsWithFriends</span><span class="o">.</span><span class="no">JamChannel</span>&#x000A;&#x000A;  <span class="k">def</span> <span class="n">connect</span><span class="p">(</span><span class="n">_params</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="no">UUID</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())}</span>&#x000A;  <span class="k">end</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre>
<p>Finally, the <code>JamChannel</code> module [<a href="https://github.com/jeffcole/loops_with_friends/blob/back-end-blog-posts/web/channels/jam_channel.ex">source</a> | <a href="https://github.com/jeffcole/loops_with_friends/blob/back-end-blog-posts/test/channels/jam_channel_test.exs">test</a>] implements the <code>join</code> function, which matches on the topic requested by the client, replies with the user's ID, and assigns the jam ID to the socket.</p>

<pre class="highlight elixir"><code><span class="c1"># web/channels/jam_channel.ex</span>&#x000A;<span class="k">defmodule</span> <span class="no">LoopsWithFriends</span><span class="o">.</span><span class="no">JamChannel</span> <span class="k">do</span>&#x000A;  <span class="kn">use</span> <span class="no">LoopsWithFriends</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:channel</span>&#x000A;&#x000A;  <span class="k">def</span> <span class="n">join</span><span class="p">(</span><span class="sd">"</span><span class="s2">jams:"</span> <span class="o">&lt;&gt;</span> <span class="n">jam_id</span><span class="p">,</span> <span class="n">_params</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>&#x000A;    <span class="c1"># ...</span>&#x000A;&#x000A;    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span>&#x000A;     <span class="p">%{</span><span class="ss">user_id:</span> <span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">user_id</span><span class="p">},</span>&#x000A;     <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:jam_id</span><span class="p">,</span> <span class="n">jam_id</span><span class="p">)}</span>&#x000A;  <span class="k">end</span>&#x000A;<span class="k">end</span>&#x000A;</code></pre>
<p>At this point, the user has successfully joined the jam — but a jam of one is a very lonely jam.</p>

<p>Continue to the <a href="../jamming-with-phoenix-presence/">next post</a> to see how Phoenix Presence allows us to easily track all the players in a jam.</p>


</article>

</main>
<footer>
<a class='home' href='/' title='Home'>Home</a>
<p class='contact'>
<a href="https://github.com/jeffcole"><i class='fa fa-fw fa-2x fa-github' title='GitHub'></i>
</a><a href="https://www.linkedin.com/in/jeffreydcole"><i class='fa fa-fw fa-2x fa-linkedin' title='LinkedIn'></i>
</a><a href="mailto:jeffreydonaldcole@gmail.com"><i class='fa fa-fw fa-2x fa-envelope' title='Email'></i>
</a></p>

<p>© 2016–present Jeff Cole</p>
</footer>
<script src="../assets/javascripts/application.js"></script>
</body>
</html>
